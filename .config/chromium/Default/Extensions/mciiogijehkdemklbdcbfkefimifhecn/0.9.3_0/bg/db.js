function StoreMan(){function f(a){console.log("StoreMan::onerror: "+a)}function k(a,b){if(c){var d=c.transaction(e,"readwrite").objectStore(e);a.iterate(function(b){var c=dy_bkg.task_by_id(b);c&&(c=d.put(DYTask.to_storable(c)),c.onsuccess=function(d){a.clear(b)},c.onerror=function(a){console.log("IDB updateTask "+b+" fail");console.log(a)})});b&&b()}}function h(a){k(dy_bkg.dirtyTaskMan,function(){a&&a()})}var e="tasks",c=null,l=window.indexedDB||window.webkitIndexedDB,g=null;return{open:function(a){var b=
l.open("downloady",1);b.onerror=f;b.onsuccess=function(d){d=b.result;!b.hasOwnProperty("onupgradeneeded")&&d.setVersion?(console.log("Your Chrome's version is too low, indexedDB doesn't work well"),alert("Your Chrome's version is too low, indexedDB doesn't work well")):(c=d,d.onerror=f,console.log("dbopened"),a&&setTimeout(a,0))};b.onupgradeneeded=function(a){console.log("dbupgradeneeded");a=a.target.result;console.log("dbupdated");a.createObjectStore(e,{keyPath:"id"})}},close:function(){c&&(c.close(),
c=null)},clear:function(a){if(c){var b=c.transaction([e],"readwrite");b.onerror=f;b.objectStore(e).clear().onsuccess=function(b){a&&a()}}else a&&a()},removeTaskById:function(a){if(c){var b=c.transaction(e,"readwrite").objectStore(e)["delete"](a);b.onsuccess=function(a){};b.onerror=function(b){console.log("IDB removeTaskById "+a+" fail");console.log(b)}}},removeTasks:function(a){if(c)for(var b=c.transaction(e,"readwrite").objectStore(e),d=0;d<a.length;++d)b["delete"](a[d].id)},removeIds:function(a){if(c)for(var b=
c.transaction(e,"readwrite").objectStore(e),d=0;d<a.length;++d)b["delete"](a[d])},getAllTasks:function(a){if(c){var b=[],d=c.transaction(e).objectStore(e).openCursor();d.onsuccess=function(c){(c=c.target.result)?(b.push(new DYTask(c.value)),c["continue"]()):(console.log("getAllTasks finished"),a(b))};d.onerror=function(c){a(b);console.log(c)}}else console.log("getAllTasks: db not ready"),a([])},commit:h,start_timer:function(){g=setInterval(h,3E3)},stop_timer:function(){clearInterval(g);g=null}}}
var dy_store=new StoreMan;
