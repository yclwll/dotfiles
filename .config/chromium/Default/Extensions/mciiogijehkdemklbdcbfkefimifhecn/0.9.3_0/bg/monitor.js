function URLMonitor(){function k(a){if("in_progress"==a.state&&(a.byExtensionId&&console.log(a.byExtensionId),!dy_engine.handleSelfIssued(a))){var c=a.url,f=a.referrer;if(dy_rules.is_prompt(c))chrome.downloads.cancel(a.id,function(){chrome.downloads.erase({id:a.id})}),dy_tabman.getLastTab(function(a){var b={cmd:"d_one",task:{}};b.task.url=c;b.task.referer=f;var d=h[c];d?(b.task.text=d.text,b.task.title=d.title,b.task.desc=d.download||d.text||d.title):console.log("url desc not found");chrome.tabs.sendMessage(a.id,
b,function(a){a||dy_tabman.open_ui({activate:!0},function(){chrome.runtime.sendMessage(b)})})});else{var b=dy_settings.get("def_addpause"),d=function(){var b=dy_bkg.create_task(a.url,a.referrer);if(!b)return null;var c=dy_settings.get_taskdef();b.naming=c.naming;b.folder=c.folder;b.threads=c.threads;b.mime_type=a.mime;b.size=a.totalBytes;b.exists=a.exists;(c=h[b.url])?(b.text=c.text,b.title=c.title,b.desc=c.download||b.text||b.title,b.page_title=c.page_title):console.log("url desc not found");return b}();
d?b||!dy_engine.idle_sync()?(chrome.downloads.cancel(a.id,function(){chrome.downloads.erase({id:a.id})}),DYTask.reset(d,b?DyEnums.TaskState.PAUSE:DyEnums.TaskState.QUEUE),b||(dy_taskstarter.enqueue(d),dy_bkg.showBadge(!0)),dy_bkg.add_display_task(d,b)):(d.state=DyEnums.TaskState.DOWNLOAD,e[a.id]=d):(chrome.downloads.cancel(a.id,function(){chrome.downloads.erase({id:a.id})}),dy_tabman.open_ui({activate:!0},function(){chrome.runtime.sendMessage({cmd:"u_alert",data:DyStrings.Error.noID})}))}}}function l(a){var c=
e[a.id];if(c){for(var f in a){var b=a[f].current;switch(f){case "url":c.eurl=b;break;case "mime":c.mime_type=b;break;case "exists":c.exists=b;break;case "endTime":c.time_finish=new Date(b);break;case "state":"interrupted"==b?c.state=DyEnums.TaskState.INTERRUPTED:"complete"==b?c.state=DyEnums.TaskState.FINISH:"in_progress"==b&&(b=a.paused,c.state=b&&b.current?DyEnums.TaskState.PAUSE:DyEnums.TaskState.DOWNLOAD);break;case "paused":a.state||(c.state=b?DyEnums.TaskState.PAUSE:DyEnums.TaskState.DOWNLOAD);
break;case "error":if((c.error_str=b)&&0==b.toUpperCase().indexOf("USER_")){delete e[a.id];console.log("cancel in Save As: "+a.id);return}break;case "totalBytes":case "fileSize":c.size=b;break;case "danger":"safe"!=b&&"accepted"!=b&&(c._danger=!0)}}(f=a.filename)&&!f.previous&&(delete e[a.id],c.full_path=f.current,dy_engine.addChromeTask(c,a.id,f.current,!1))}}function m(a){e[a]&&(console.log("cancel in Save As: "+a),delete e[a])}var e={},h={},g=[];return{getTask:function(a){return e[a]},getDesc:function(a){return h[a]},
setURLDesc:function(a,c,f,b,d){if(a){if(void 0!=h[a])for(var e=0;e<g.length;++e)if(g[e]==a){g.splice(e,1);break}18<=g.length&&(delete h[g[0]],g.shift());g.push(a);h[a]={download:c,text:f,title:b,page_title:d}}},start:function(){chrome.downloads.onCreated.hasListener(k)||chrome.downloads.onCreated.addListener(k);chrome.downloads.onChanged.hasListener(l)||chrome.downloads.onChanged.addListener(l);chrome.downloads.onErased.hasListener(m)||chrome.downloads.onErased.addListener(m)},stop:function(){chrome.downloads.onCreated.removeListener(k);
chrome.downloads.onChanged.removeListener(l);chrome.downloads.onErased.removeListener(m)}}}var dy_urlmonitor=new URLMonitor;
